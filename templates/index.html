<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>GestÃ£o dos Tickets</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <h1>GestÃ£o dos Tickets</h1>

    <!-- Formulaire pour ajouter un ticket -->
    <input type="text" id="ticketName" placeholder="Nome do ticket">
    <input type="text" id="ticketAction" placeholder="AÃ§Ã£o a realizar">
    <select id="ticketStatus">
        <option value="Atraso da encomenda">Atraso da encomenda</option>
        <option value="Produto chegou quebrado e/ou amassado">Produto chegou quebrado e/ou amassado</option>
        <option value="Erro no produto enviado">Erro no produto enviado</option>
        <option value="Erro no endereÃ§o">Erro no endereÃ§o</option>
        <option value="Outros">Outros</option>
    </select>
    <button id="createTicketButton">Criar um Ticket</button>

    <h2>Lista de Tickets</h2>
    <ul id="ticketList"></ul>

<script>
console.log("Script carregado!");

async function fetchTickets() {
    console.log("ğŸ”„ Chargement des tickets...");
    const response = await fetch("https://gestion-tickets-h93q.onrender.com/tickets", { cache: "no-store" });
    const tickets = await response.json();
    console.log("âœ… Tickets chargÃ©s :", tickets);
    
    const list = document.getElementById("ticketList");
    list.innerHTML = "";
    tickets.forEach(ticket => {
        const li = document.createElement("div");
        li.className = "ticket";
        li.innerHTML = `
            <strong>${ticket.name}</strong>  
            <p><em>${ticket.status}</em> | <span style="color:gray;">ğŸ—“ ${ticket.created_at}</span></p>
            <p>ğŸ“Œ AÃ§Ã£o: ${ticket.action}</p>
            <button style="background: green; color: white;" onclick="resolveTicket(${ticket.id})">
                ${ticket.resolved ? "âœ… Resolvido" : "Marcar como resolvido"}
            </button>
            <button style="background: red; color: white;" onclick="deleteTicket(${ticket.id})">
                âŒ Excluir
            </button>
            <div class="comments">
                <h4>ComentÃ¡rios</h4>
                <div id="comments-${ticket.id}">
                    ${(ticket.comments || []).map((c, index) => `
                        <div class="comment-container">
                            <span class="comment-text">ğŸ“ ${c.text} <span style="color:gray;">(${c.date})</span></span>
                            <span class="comment-delete" onclick="deleteComment(${ticket.id}, ${index})">&times;</span>
                        </div>
                    `).join('')}
                </div>
                <input type="text" id="comment-input-${ticket.id}" placeholder="Adicionar um comentÃ¡rio">
                <button onclick="addComment(${ticket.id})">ğŸ’¬ Adicionar</button>
            </div>
        `;
        list.appendChild(li);
    });
}

// Charger les tickets immÃ©diatement au dÃ©marrage
document.addEventListener("DOMContentLoaded", fetchTickets);

document.getElementById("createTicketButton").addEventListener("click", createTicket);

async function resolveTicket(id) {
    console.log("resolveTicket() chamada para o ticket:", id);
    const response = await fetch(`https://gestion-tickets-h93q.onrender.com/tickets/${id}`, {
        method: "PUT"
    });

    if (!response.ok) {
        alert("Erro ao marcar como resolvido!");
        return;
    }

    fetchTickets();
}

async function deleteTicket(id) {
    console.log("deleteTicket() chamada para o ticket:", id);
    if (!confirm("VocÃª realmente deseja excluir este ticket?")) return;

    const response = await fetch(`https://gestion-tickets-h93q.onrender.com/tickets/${id}`, {
        method: "DELETE"
    });

    if (!response.ok) {
        alert("Erro ao excluir o ticket!");
        return;
    }

    fetchTickets();
}

window.resolveTicket = resolveTicket;
window.deleteTicket = deleteTicket;
window.addComment = addComment;
window.deleteComment = deleteComment;

fetchTickets();
</script>
</body>
</html>
