<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Gestion des Tickets</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <h1>Gestion des Tickets</h1>

    <!-- Formulaire pour ajouter un ticket -->
    <input type="text" id="ticketName" placeholder="Nom du ticket">
    <input type="text" id="ticketAction" placeholder="Action √† r√©aliser">
    <select id="ticketStatus">
        <option value="Colis en retard">Colis en retard</option>
        <option value="Colis endommag√©">Colis endommag√©</option>
        <option value="Erreur produit">Erreur produit</option>
        <option value="Erreur adresse">Erreur adresse</option>
        <option value="Autres">Autres</option>
    </select>
    <button id="createTicketButton">Cr√©er un Ticket</button>

    <h2>Liste des Tickets</h2>
    <ul id="ticketList"></ul>

<script>
console.log("Script charg√© !");

async function fetchTickets() {
    console.log("fetchTickets() a √©t√© charg√©e !");
    const response = await fetch("/tickets");
    const tickets = await response.json();
    const list = document.getElementById("ticketList");
    list.innerHTML = "";
    tickets.forEach(ticket => {
        const li = document.createElement("div");
        li.className = "ticket";
        li.innerHTML = `
            <strong>${ticket.name}</strong>  
            <p><em>${ticket.status}</em> | <span style="color:gray;">üóì ${ticket.created_at}</span></p>
            <p>üìå Action : ${ticket.action}</p>
            <button style="background: green; color: white;" onclick="resolveTicket(${ticket.id})">
                ${ticket.resolved ? "‚úÖ R√©solu" : "Marquer comme r√©solu"}
            </button>
            <button style="background: red; color: white;" onclick="deleteTicket(${ticket.id})">
                ‚ùå Supprimer
            </button>
            <div class="comments">
                <h4>Commentaires</h4>
                <div id="comments-${ticket.id}">
                    ${(ticket.comments || []).map((c, index) => `
                        <div class="comment-container">
                            <span class="comment-text">üìù ${c.text} <span style="color:gray;">(${c.date})</span></span>
                            <span class="comment-delete" onclick="deleteComment(${ticket.id}, ${index})">&times;</span>
                        </div>
                    `).join('')}
                </div>
                <input type="text" id="comment-input-${ticket.id}" placeholder="Ajouter un commentaire">
                <button onclick="addComment(${ticket.id})">üí¨ Ajouter</button>
            </div>
        `;
        list.appendChild(li);
    });
}

async function createTicket() {
    console.log("createTicket() est bien charg√©e !");
    const name = document.getElementById("ticketName").value;
    const action = document.getElementById("ticketAction").value;
    const status = document.getElementById("ticketStatus").value;
    
    if (!name || !action) return alert("Veuillez remplir tous les champs.");
    
    try {
        const response = await fetch("https://gestion-tickets-h93q.onrender.com/tickets", {
            method: "POST",
            headers: {
                "Accept": "application/json",
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ name, status, action })
        });

        if (!response.ok) {
            const errorText = await response.text();
            alert("Erreur lors de la cr√©ation du ticket : " + errorText);
            return;
        }
        fetchTickets();
    } catch (error) {
        console.error("Erreur de connexion √† l'API :", error);
        alert("Impossible de contacter le serveur.");
    }
}

document.getElementById("createTicketButton").addEventListener("click", createTicket);

async function addComment(ticketId) {
    const commentInput = document.getElementById(`comment-input-${ticketId}`);
    const commentText = commentInput.value.trim();
    
    if (!commentText) return alert("Le commentaire ne peut pas √™tre vide.");
    
    const response = await fetch(`/tickets/${ticketId}/comment`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ comment: commentText })
    });
    
    if (!response.ok) {
        alert("Erreur lors de l'ajout du commentaire.");
        return;
    }
    
    commentInput.value = "";
    fetchTickets();
}

async function deleteComment(ticketId, commentIndex) {
    if (!confirm("Voulez-vous vraiment supprimer ce commentaire ?")) return;
    
    const response = await fetch(`/tickets/${ticketId}/comment/${commentIndex}`, { method: "DELETE" });
    
    if (!response.ok) {
        alert("Erreur lors de la suppression du commentaire.");
        return;
    }
    
    fetchTickets();
}

fetchTickets();
</script>
</body>
</html>



