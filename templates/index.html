<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Gestion des Tickets</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <h1>Gestion des Tickets</h1>

    <!-- Formulaire pour ajouter un ticket -->
<input type="text" id="ticketName" placeholder="Nom du ticket">
<input type="text" id="ticketAction" placeholder="Action √† r√©aliser">
<select id="ticketStatus">
    <option value="Colis en retard">Colis en retard</option>
    <option value="Colis endommag√©">Colis endommag√©</option>
    <option value="Erreur produit">Erreur produit</option>
    <option value="Erreur adresse">Erreur adresse</option>
    <option value="Autres">Autres</option>
</select>
<button onclick="createTicket()">Cr√©er un Ticket</button>

    <h2>Liste des Tickets</h2>
    <ul id="ticketList"></ul>

<script>
async function fetchTickets() {
    const response = await fetch("/tickets");
    const tickets = await response.json();
    const list = document.getElementById("ticketList");
    list.innerHTML = "";
    tickets.forEach(ticket => {
        const li = document.createElement("div");
        li.className = "ticket";
        li.innerHTML = `
            <strong>${ticket.name}</strong>  
            <p><em>${ticket.status}</em> | <span style="color:gray;">üóì ${ticket.created_at}</span></p>
            <p>üìå Action : ${ticket.action}</p>
            <button class="resolve" onclick="resolveTicket(${ticket.id})">
                ${ticket.resolved ? "‚úÖ R√©solu" : "Marquer comme r√©solu"}
            </button>
            <button class="delete" onclick="deleteTicket(${ticket.id})">
                ‚ùå Supprimer
            </button>
            <div class="comments">
                <h4>Commentaires</h4>
                <div id="comments-${ticket.id}">
                 ${(ticket.comments || []).map((c, index) => `
    <div class="comment-container">
        <span class="comment-text">üìù ${c.text} <span style="color:gray;">(${c.date})</span></span>
        <span class="comment-delete" onclick="deleteComment(${ticket.id}, ${index})">&times;</span>
    </div>
`).join('')}




                </div>
                <input type="text" id="comment-input-${ticket.id}" placeholder="Ajouter un commentaire">
                <button onclick="addComment(${ticket.id})">üí¨ Ajouter</button>
            </div>
        `;
        list.appendChild(li);
    });
}

async function deleteComment(ticketId, commentIndex) {
    if (!confirm("Voulez-vous vraiment supprimer ce commentaire ?")) return;

    const response = await fetch(`/tickets/${ticketId}/comment/${commentIndex}`, { method: "DELETE" });

    if (!response.ok) {
        alert("Erreur lors de la suppression du commentaire.");
        return;
    }

    fetchTickets(); // Recharger les tickets pour mettre √† jour l'affichage
}

    async function addComment(ticketId) {
        const commentInput = document.getElementById(`comment-input-${ticketId}`);
        const commentText = commentInput.value.trim();
        
        if (!commentText) return alert("Le commentaire ne peut pas √™tre vide.");
    
        const response = await fetch(`/tickets/${ticketId}/comment`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ comment: commentText })
        });
    
        if (!response.ok) {
            alert("Erreur lors de l'ajout du commentaire.");
            return;
        }
    
        commentInput.value = "";
        fetchTickets(); // Recharger les tickets pour afficher le nouveau commentaire
    }

    async function resolveTicket(id) {
        await fetch(`/tickets/${id}`, { method: "PUT" });
        fetchTickets();
    }

    async function deleteTicket(id) {
        if (!confirm("Voulez-vous vraiment supprimer ce ticket ?")) return;

        const response = await fetch(`/tickets/${id}`, { method: "DELETE" });

        if (!response.ok) {
            alert("Erreur lors de la suppression du ticket !");
            return;
        }

        fetchTickets();
    }

    fetchTickets();
</script>
</body>
</html>



